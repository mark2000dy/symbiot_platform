<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Sistema de Gastos Symbiot</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#191C24" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(135deg, #000 0%, #191c24 50%, #000 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .auth-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .auth-box {
        background: rgba(25, 28, 36, 0.9);
        border-radius: 15px;
        padding: 3rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        max-width: 400px;
        width: 100%;
      }
      .logo {
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo h1 {
        color: #eb1616;
        font-weight: bold;
        font-size: 2rem;
      }
      .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.75rem 1rem;
      }
      .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: #eb1616;
        box-shadow: 0 0 0 0.2rem rgba(235, 22, 22, 0.25);
        color: white;
      }
      .form-control::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }
      .btn-login {
        background: linear-gradient(45deg, #eb1616, #ff4444);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .btn-login:hover {
        background: linear-gradient(45deg, #ff4444, #eb1616);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(235, 22, 22, 0.4);
      }
      .form-label {
        color: white;
        font-weight: 500;
      }
      .form-check-label {
        color: rgba(255, 255, 255, 0.8);
      }
      .demo-users {
        text-align: center;
        margin-top: 2rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }
      .alert {
        border: none;
        border-radius: 10px;
      }
      .loading-spinner {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="auth-wrapper">
      <div class="auth-box">
        <div class="logo">
          <img
            src="assets/images/Symbiot_logo_dark.png"
            alt="SYMBIOT Logo"
            style="max-width: 150px; height: auto"
          />
          <p class="text-muted">Sistema de Gastos e Ingresos</p>
        </div>

        <!-- Contenedor de alertas -->
        <div id="alertContainer"></div>

        <form id="loginForm">
          <div class="mb-3">
            <label for="email" class="form-label">
              <i class="fas fa-envelope me-2"></i>Correo Electrónico
            </label>
            <input
              type="email"
              class="form-control"
              id="email"
              placeholder="usuario@symbiot.com"
              required
            />
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">
              <i class="fas fa-lock me-2"></i>Contraseña
            </label>
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="••••••••"
              required
            />
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="rememberMe" />
            <label class="form-check-label" for="rememberMe">
              Recordar mi correo
            </label>
          </div>

          <button
            type="submit"
            class="btn btn-login w-100 text-white"
            id="loginBtn"
          >
            <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
          </button>
        </form>

        <div class="demo-users">
          <h6 class="text-white mb-2">👤 Usuarios de Prueba:</h6>
          <small class="text-muted">
            <strong>Admin:</strong> marco.delgado@symbiot.com.mx / admin123<br />
            <strong>Admin:</strong> arazo@rockstarskull.com / admin123<br />
            <strong>User:</strong> hvazquez@rockstarskull.com / admin123
          </small>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 🔥 LOGIN REAL CONECTADO A LA API
      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const loginBtn = document.getElementById("loginBtn");
          const alertContainer = document.getElementById("alertContainer");

          // Limpiar alertas anteriores
          alertContainer.innerHTML = "";

          // Mostrar loading
          loginBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando sesión...';
          loginBtn.disabled = true;

          try {
            console.log("🔐 Intentando login con:", email);

            // ✅ LLAMADA REAL A LA API
            const response = await fetch(
              "/symbiot/finance_manager/api/auth.php?action=login",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                },
                body: JSON.stringify({ email, password }),
              }
            );

            const data = await response.json();
            console.log("📋 Respuesta del servidor:", data);

            if (data.success) {
              // ✅ LOGIN EXITOSO
              console.log("✅ Login exitoso para:", data.user.nombre);

              // Guardar email si "recordarme" está activo
              if (document.getElementById("rememberMe").checked) {
                localStorage.setItem("rememberedEmail", email);
              }

              // Mostrar éxito
              alertContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ¡Bienvenido ${data.user.nombre}! Redirigiendo...
                        </div>
                    `;

              // Redirigir después de 1 segundo
              setTimeout(() => {
                window.location.href =
                  data.data.redirectUrl ||
                  "/symbiot/finance_manager/public/dashboard.html";
              }, 1000);
            } else {
              // ❌ LOGIN FALLIDO
              throw new Error(data.error || "Credenciales inválidas");
            }
          } catch (error) {
            console.error("❌ Error en login:", error);

            // Mostrar error
            alertContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${error.message}
                    </div>
                `;

            // Focus en password para reintento
            document.getElementById("password").focus();
            document.getElementById("password").select();
          } finally {
            // Resetear botón siempre
            loginBtn.innerHTML =
              '<i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión';
            loginBtn.disabled = false;
          }
        });

      // 🔄 Recordar email al cargar página
      document.addEventListener("DOMContentLoaded", function () {
        const rememberedEmail = localStorage.getItem("rememberedEmail");
        if (rememberedEmail) {
          document.getElementById("email").value = rememberedEmail;
          document.getElementById("rememberMe").checked = true;
          // Focus en password si el email ya está recordado
          document.getElementById("password").focus();
        } else {
          // Focus en email si está vacío
          document.getElementById("email").focus();
        }
      });

      // 🔧 Auto-completar credenciales de prueba (solo para desarrollo)
      document.addEventListener("keydown", function (e) {
        // Ctrl + 1 para admin Marco
        if (e.ctrlKey && e.key === "1") {
          e.preventDefault();
          document.getElementById("email").value =
            "marco.delgado@symbiot.com.mx";
          document.getElementById("password").value = "admin123";
          document.getElementById("password").focus();
        }
        // Ctrl + 2 para admin Antonio
        if (e.ctrlKey && e.key === "2") {
          e.preventDefault();
          document.getElementById("email").value = "arazo@rockstarskull.com";
          document.getElementById("password").value = "admin123";
          document.getElementById("password").focus();
        }
        // Ctrl + 3 para user Hugo
        if (e.ctrlKey && e.key === "3") {
          e.preventDefault();
          document.getElementById("email").value = "hvazquez@rockstarskull.com";
          document.getElementById("password").value = "admin123";
          document.getElementById("password").focus();
        }
      });

      // 🌐 Verificar conectividad con el servidor
      window.addEventListener("load", async function () {
        try {
          const healthResponse = await fetch("/gastos/api/health");
          const healthData = await healthResponse.json();

          if (healthData.status === "OK") {
            console.log("✅ Servidor conectado:", healthData);
          } else {
            console.warn("⚠️ Problemas con el servidor:", healthData);
          }
        } catch (error) {
          console.error("❌ No se puede conectar con el servidor:", error);
          document.getElementById("alertContainer").innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Sin conexión al servidor. Verifique que esté ejecutándose.
                    </div>
                `;
        }
      });
    </script>
  </body>
</html>
